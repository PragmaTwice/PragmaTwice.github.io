<!DOCTYPE html>
<html lang=en>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="repost from https:&#x2F;&#x2F;kvrocks.apache.org&#x2F;blog&#x2F;kqir-query-engine Intro TL;DR:   demo  Pretty cool, right? Let&#39;s dive in! (The full example is provided in the final section.)  Apache Kvrocks Apache Kvrock">
<meta property="og:type" content="article">
<meta property="og:title" content="KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries">
<meta property="og:url" content="https://imtwice.com/kqir-query-engine/index.html">
<meta property="og:site_name" content="I&#39;m Twice">
<meta property="og:description" content="repost from https:&#x2F;&#x2F;kvrocks.apache.org&#x2F;blog&#x2F;kqir-query-engine Intro TL;DR:   demo  Pretty cool, right? Let&#39;s dive in! (The full example is provided in the final section.)  Apache Kvrocks Apache Kvrock">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://imtwice.com/images/kqir-query-engine/demo.png">
<meta property="og:image" content="https://imtwice.com/images/kqir-query-engine/KQIR.png">
<meta property="article:published_time" content="2024-06-02T04:00:00.000Z">
<meta property="article:modified_time" content="2025-12-11T13:49:44.108Z">
<meta property="article:author" content="Pragma Twice">
<meta property="article:tag" content="kvrocks">
<meta property="article:tag" content="query engine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imtwice.com/images/kqir-query-engine/demo.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114681413-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-114681413-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="I&#39;m Twice" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body class="max-width mx-auto px3 ltr">    
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/kvrocks-cocasia25/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/twices-game-list/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://imtwice.com/kqir-query-engine/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://imtwice.com/kqir-query-engine/&text=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://imtwice.com/kqir-query-engine/&is_video=false&description=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries&body=Check out this article: https://imtwice.com/kqir-query-engine/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://imtwice.com/kqir-query-engine/&name=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://imtwice.com/kqir-query-engine/&t=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#apache-kvrocks"><span class="toc-number">1.1.</span> <span class="toc-text">Apache Kvrocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-capability-to-query"><span class="toc-number">1.2.</span> <span class="toc-text">The capability to query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redisearch"><span class="toc-number">1.3.</span> <span class="toc-text">RediSearch?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql"><span class="toc-number">1.4.</span> <span class="toc-text">SQL?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#how-we-support-both"><span class="toc-number">2.</span> <span class="toc-text">How we support both?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kqir-a-multiple-level-ir"><span class="toc-number">2.1.</span> <span class="toc-text">KQIR: a multiple-level IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ir-optimizer"><span class="toc-number">2.2.</span> <span class="toc-text">IR Optimizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plan-executor"><span class="toc-number">2.3.</span> <span class="toc-text">Plan Executor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#on-disk-indexing"><span class="toc-number">2.4.</span> <span class="toc-text">On-disk indexing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#current-status"><span class="toc-number">3.</span> <span class="toc-text">Current status</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#supported-field-types"><span class="toc-number">3.1.</span> <span class="toc-text">Supported field types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transaction-guarantees"><span class="toc-number">3.2.</span> <span class="toc-text">Transaction guarantees</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limitation-on-ir-optimizer"><span class="toc-number">3.3.</span> <span class="toc-text">Limitation on IR optimizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#relationship-with-other-features"><span class="toc-number">3.4.</span> <span class="toc-text">Relationship with other
features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compliance"><span class="toc-number">3.5.</span> <span class="toc-text">Compliance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#high-experimental"><span class="toc-number">3.6.</span> <span class="toc-text">High experimental!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#future-outlook"><span class="toc-number">4.</span> <span class="toc-text">Future outlook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vector-search"><span class="toc-number">4.1.</span> <span class="toc-text">Vector search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#full-text-search"><span class="toc-number">4.2.</span> <span class="toc-text">Full-text search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#more-sql-features"><span class="toc-number">4.3.</span> <span class="toc-text">More SQL features</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#try-it"><span class="toc-number">5.</span> <span class="toc-text">Try it!</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Pragma Twice</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-06-02T04:00:00.000Z" class="dt-published" itemprop="datePublished">2024-06-02</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/projects/">projects</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/kvrocks/" rel="tag">kvrocks</a>, <a class="p-category" href="/tags/query-engine/" rel="tag">query engine</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><em>repost from <a
target="_blank" rel="noopener" href="https://kvrocks.apache.org/blog/kqir-query-engine">https://kvrocks.apache.org/blog/kqir-query-engine</a></em></p>
<h2 id="intro">Intro</h2>
<p>TL;DR:</p>
<figure>
<img src="/images/kqir-query-engine/demo.png" alt="demo" />
<figcaption aria-hidden="true">demo</figcaption>
</figure>
<p>Pretty cool, right? Let's dive in!</p>
<p>(The full example is provided in <a href="#try-it">the final
section</a>.)</p>
<!--truncate-->
<h3 id="apache-kvrocks">Apache Kvrocks</h3>
<p><a target="_blank" rel="noopener" href="https://kvrocks.apache.org/">Apache Kvrocks</a> is a <a
target="_blank" rel="noopener" href="https://redis.io/">Redis</a>-compatible database built on <a
target="_blank" rel="noopener" href="https://rocksdb.org/">RocksDB</a>.</p>
<p>It supports <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/reference/protocol-spec/">the
RESP protocol</a> (version 2 and 3) and <a
target="_blank" rel="noopener" href="https://kvrocks.apache.org/docs/supported-commands">a wide range
of Redis commands</a>, encompassing core data structures like Strings,
Sets, Hashes, Sorted Sets, Stream, GEO, as well as Lua Scripts,
Transactions, <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/interact/programmability/functions-intro/">Functions</a>
and even <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/data-types/probabilistic/bloom-filter/">BloomFilter</a>,
<a target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/data-types/json/">JSON</a>
from the Redis Stack.</p>
<p>Unlike Redis which stores data in memory, Kvrocks persists data on
disk for improved storage capabilities without being constrained by
machine memory limit.</p>
<h3 id="the-capability-to-query">The capability to query</h3>
<p>In recent years, NoSQL databases have become more popular than
traditional databases because they perform better, scale easily, and are
more flexible for different industries.</p>
<p>However, many users are unwilling to abandon the essential features
of SQL databases just for performance reasons. These include ACID
transactions, expressive query capabilities inherent in SQL, as well as
optimization and abstraction possibilities offered by structured data
and relational algebra. Consequently, a new category of databases known
as NewSQL has emerged gradually.</p>
<p>Kvrocks is a NoSQL database. While not classified as NewSQL, Kvrocks
aims to strike a balance between NoSQL and NewSQL paradigms: It aims to
maintain the high performance of NoSQL while also implementing
transaction guarantees and supporting more complex queries.</p>
<h3 id="redisearch">RediSearch?</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/RediSearch/RediSearch">RediSearch</a> is
a Redis module that enhances Redis with query, secondary indexing, and
full-text search functionalities. While <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/operate/oss_and_stack/stack-with-enterprise/search/commands/">its
Redis commands</a> begin with <code>FT.</code> (i.e. full text), it goes
beyond just full-text search.</p>
<p>In fact, it is Redis moving closer to SQL databases: RediSearch
enables users to create structured schemas on existing Redis JSON or
HASH data for index building. Its schema supports <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/interact/search-and-query/basic-constructs/field-and-type-options/">various
field types</a> such as numeric, tag, geo, text, and vector - the latter
two are utilized for full-text and vector searches. Instead of SQL
support, RediSearch provides <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/">a
unique query syntax</a> known as the RediSearch query language.</p>
<p>RediSearch finds applications in various fields. One recent
application involves utilizing its vector search feature to develop
retrieval-augmented generation (RAG). For instance, <a
target="_blank" rel="noopener" href="https://www.langchain.com/">LangChain</a> utilizes Redis as one of
its vector database. If Kvrocks can be compatible with RediSearch, it
could benefit from these ecosystem from RediSearch.</p>
<h3 id="sql">SQL?</h3>
<p>RediSearch uses a unique syntax for queries, but there are some
issues to consider:</p>
<p>Firstly, RediSearch's schema (a.k.a. index, created with
<code>FT.CREATE</code>) can be regarded as a table in an SQL database.
Its query syntax also aligns semantically with SQL queries. Given this
similarity, supporting SQL should not increase significant challenges;
why not include SQL support as well?</p>
<p>Secondly, SQL enjoys broader usage and is familiar to more
individuals. It is simpler to learn at the syntax level. While
developers may need time to understand RediSearch query syntax, adapting
to a new SQL database often requires less effort. Furthermore, SQL
offers robust support for various query features, enhanced expressive
capabilities (like JOINs, subqueries, aggregations).</p>
<p>Finally, RediSearch query syntax suffers from some historical
designs. For example, the operator precedence of AND and OR (represented
by space and <code>|</code> operator in RediSearch queries) <a
target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/#basic-syntax">varies
across different dialect versions</a> (dialect 1 vs. dialect 2). This
tribal knowledge might lead users to prefer established query
languages.</p>
<p>To sum up, we believe that supporting SQL as a querying language
would be a good decision.</p>
<h2 id="how-we-support-both">How we support both?</h2>
<figure>
<img src="/images/kqir-query-engine/KQIR.png" alt="KQIR" />
<figcaption aria-hidden="true">KQIR</figcaption>
</figure>
<p>To introduce SQL capability to Kvrocks, we need to design a robust
architecture with scalability, maintainability, and strong query
planning and optimization features.</p>
<p>We plan to accomplish this through <a
target="_blank" rel="noopener" href="https://github.com/apache/kvrocks/tree/unstable/src/search">KQIR</a>.
In the context of Kvrocks, KQIR stands for both: 1. The complete query
engine, covering frontend language parsing, query optimization and
execution, etc. 2. An intermediate language (IR) that traverses the
entire query engine.</p>
<h3 id="kqir-a-multiple-level-ir">KQIR: a multiple-level IR</h3>
<p>To support both SQL and RediSearch queries, an intermediate language
(IR) is necessary to handle them consistently in subsequent processes
without concern for the user's input language.</p>
<p>We have developed parsers for a subset of MySQL syntax and RediSearch
queries, converting the resulting syntax tree into KQIR.</p>
<p>And KQIR is a multi-level IR that can represent query structures at
various levels during optimization. The initial transformation from the
syntax tree results in Syntactical IR, a high-level representation of
certain syntactic expressions. As it undergoes processing by an IR
optimizer, KQIR evolves into Planning IR, a low-level representation
used to express query execution plans within the query engine.</p>
<p>Additionally, we will conduct semantic checks on the IR before
optimization to ensure that the query is semantically correct. This
includes verifying that it does not include any undefined schemas or
fields and uses the appropriate field types.</p>
<h3 id="ir-optimizer">IR Optimizer</h3>
<p>The KQIR optimizer consists of multiple passes, <a
target="_blank" rel="noopener" href="https://llvm.org/docs/Passes.html">a concept borrowed from
LLVM</a>. Each pass takes IR as input, conducts analysis and
modifications, and generates a new IR.</p>
<p>Currently, the optimizer's passes are categorized into three main
groups: - expression passes for optimizing logical expressions like
<code>AND</code>, <code>OR</code>, <code>NOT</code> operators; - numeric
passes for optimizing numerical comparisons with an interval analysis
(i.e. analyze the mathematical properties of numerical comparisons in
terms of intervals) to enhance query optimization by eliminating
unnecessary comparisons or improving comparison expressions; - planning
passes for converting syntactical IR to planning IR and enhancing query
plans through a cost model that selects optimal indexes and removes
unnecessary sortings.</p>
<p>Pass execution order is controlled by the pass manager. A pass may
run multiple times at different stages to simplify individual passes by
combining them.</p>
<h3 id="plan-executor">Plan Executor</h3>
<p>The KQIR plan executor is built on the Volcano model.</p>
<p>Once the IR optimizer finishes all optimizations, the resulting IR
becomes a planning IR. This will then be passed to the plan executor to
create execution logic based on certain context corresponding to the
plan operator.</p>
<p>Subsequently, Kvrocks retrieves query results through iterative
execution.</p>
<h3 id="on-disk-indexing">On-disk indexing</h3>
<p>Unlike Redis, which stores index data in memory, Kvrocks requires the
construction of indexes on the disk. This means that for any field type
(e.g. tag, numeric), we need an encoding to reduce such index to
RocksDB's key-values.</p>
<p>Furthermore, we incrementally create indexes before and after JSON or
HASH commands getting executed to guarantee that query results are in
real-time.</p>
<h2 id="current-status">Current status</h2>
<p>The KQIR functionality is currently available on the
<code>unstable</code> branch, supporting commands like
<code>FT.CREATE</code>, <code>FT.SEARCH</code>, and
<code>FT.SEARCHSQL</code> (an extension for running SQL queries) to
encourage user to test.</p>
<p>However, as KQIR is still in early development, compatibility cannot
be guaranteed and many features remain incomplete. Thus the upcoming
release (version 2.9.0) will not include any KQIR component.</p>
<h3 id="supported-field-types">Supported field types</h3>
<p>Currently, we only support two field types: tag and numeric.</p>
<p>Tag fields label each data record with multiple tags for filtering in
queries. And numeric fields hold numerical data within double-precision
floating-point ranges. They allow sorting and filtering by specific
numerical ranges.</p>
<p>In the future, we plan to expand support to include vector search and
full-text search capabilities alongside other field types.</p>
<h3 id="transaction-guarantees">Transaction guarantees</h3>
<p>Currently, the transaction guarantee of KQIR is weak, which may lead
to unexpected issues during use.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/kvrocks/issues/2331">Another
project in the Kvrocks community</a> aims to enhance Kvrocks'
transaction support by establishing a structured framework. We will
leverage these efforts to uphold the ACID properties of KQIR and release
an official version incorporating KQIR after that.</p>
<h3 id="limitation-on-ir-optimizer">Limitation on IR optimizer</h3>
<p>Currently, KQIR does not use the cost model when optimizing record
sorting. Instead, it relies on specialized logic. This could be an area
for improvement soon.</p>
<p>Furthermore, KQIR does not currently utilize optimizations based on
runtime statistics. Our future focus will be on integrating runtime
statistics into the cost model for more precise index selection.</p>
<h3 id="relationship-with-other-features">Relationship with other
features</h3>
<p>KQIR integrates well with the <a
target="_blank" rel="noopener" href="https://kvrocks.apache.org/docs/namespace">namespace</a> feature.
Any index created is restricted to the current namespace and cannot be
accessed in other namespaces, aligning with how other data is accessed
within the namespace.</p>
<p>Currently, KQIR cannot be enabled in the <a
target="_blank" rel="noopener" href="https://kvrocks.apache.org/docs/cluster">cluster mode</a>. Cluster
mode support may not be implemented in the short term, but we encourage
anyone to submit discussions, design proposals, or suggestions.</p>
<h3 id="compliance">Compliance</h3>
<p>While KQIR is designed to be compatible with RediSearch at the
interface level, it does not include any code from RediSearch. As
previously mentioned, KQIR features a completely new framework, and its
query architecture (including parsing, optimization, execution) is
independent of RediSearch.</p>
<p>This distinction is important due to the proprietary license under
which RediSearch is released.</p>
<h3 id="high-experimental">High experimental!</h3>
<p>The current implementation of KQIR is in its early experimental
stage. We advise users to consider carefully when using KQIR
functionalities in a production environment, as we do not guarantee
compatibility, and there may be unexpected errors.</p>
<h2 id="future-outlook">Future outlook</h2>
<p>KQIR is currently in development, and all mentioned aspects will
continue to evolve. If you're interested, please stay updated on the
progress.</p>
<p>Developers keen on KQIR are encouraged to get involved in the
development process and join the Apache Kvrocks community.</p>
<p>Note that our community consists entirely of volunteers. As an ASF
community, we strive to offer an open, inclusive, and vendor-neutral
environment.</p>
<h3 id="vector-search">Vector search</h3>
<p>The design and implementation of vector search support are currently
underway, which is very exciting.</p>
<p>In the Kvrocks community, some members have raised discussions and <a
target="_blank" rel="noopener" href="https://github.com/apache/kvrocks/discussions/2316">proposed an
encoding design</a> for implementing vector search on KQIR.</p>
<p>As per the plan, we will initially implement an on-disk HNSW index
and introduce the vector field type.</p>
<h3 id="full-text-search">Full-text search</h3>
<p>There is currently no design proposal for full-text search.</p>
<p>However, community members are exploring the potential of
incorporating full-text indexing in KQIR via <a
target="_blank" rel="noopener" href="https://clucene.sourceforge.net/">CLucene</a> or <a
target="_blank" rel="noopener" href="https://github.com/pisa-engine/pisa">PISA</a>.</p>
<p>We encourage anyone interested to share their ideas or suggestions
and get involved in the development and implementation.</p>
<h3 id="more-sql-features">More SQL features</h3>
<p>In the future, we aim to progressively broaden our support for SQL
features, potentially encompassing subqueries (including common table
expressions), JOIN operations, aggregation functions, and other
functionalities.</p>
<p>Our primary focus will remain on transaction processing rather than
analytical tasks.</p>
<h2 id="try-it">Try it!</h2>
<p>First, we can easily set up a Kvrocks instance via Docker images. You
also have the choice to manually build executable from the source code
in the 'unstable' branch.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 6666:6666 apache/kvrocks:nightly --log-dir stdout</span><br></pre></td></tr></table></figure>
<p>Then, we can connect to kvrocks locally using <code>redis-cli</code>,
and create an index named <code>testidx</code> consisting a tag field
<code>a</code> and numeric field <code>b</code> with the following
command: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE testidx ON JSON PREFIX 1 &#x27;test:&#x27; SCHEMA a TAG b NUMERIC</span><br></pre></td></tr></table></figure></p>
<p>Next, we can add some new data using Redis JSON commands: (Note that
it is also possible to add data before running <code>FT.CREATE</code>.)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JSON.SET test:k1 $ &#x27;&#123;&quot;a&quot;: &quot;x,y&quot;, &quot;b&quot;: 11&#125;&#x27;</span><br><span class="line">JSON.SET test:k2 $ &#x27;&#123;&quot;a&quot;: &quot;y,z&quot;, &quot;b&quot;: 22&#125;&#x27;</span><br><span class="line">JSON.SET test:k3 $ &#x27;&#123;&quot;a&quot;: &quot;x,z&quot;, &quot;b&quot;: 33&#125;&#x27;</span><br></pre></td></tr></table></figure></p>
<p>Finally, we can execute some SQL queries to get the desired results:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCHSQL &#x27;select * from testidx where a hastag &quot;z&quot; and b &lt; 30&#x27;</span><br></pre></td></tr></table></figure></p>
<p>Or an equivalent RediSearch query: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH testidx &#x27;@a:&#123;z&#125; @b:[-inf (30]&#x27;</span><br></pre></td></tr></table></figure></p>
<p>Enjoy it!</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#apache-kvrocks"><span class="toc-number">1.1.</span> <span class="toc-text">Apache Kvrocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-capability-to-query"><span class="toc-number">1.2.</span> <span class="toc-text">The capability to query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redisearch"><span class="toc-number">1.3.</span> <span class="toc-text">RediSearch?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql"><span class="toc-number">1.4.</span> <span class="toc-text">SQL?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#how-we-support-both"><span class="toc-number">2.</span> <span class="toc-text">How we support both?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kqir-a-multiple-level-ir"><span class="toc-number">2.1.</span> <span class="toc-text">KQIR: a multiple-level IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ir-optimizer"><span class="toc-number">2.2.</span> <span class="toc-text">IR Optimizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plan-executor"><span class="toc-number">2.3.</span> <span class="toc-text">Plan Executor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#on-disk-indexing"><span class="toc-number">2.4.</span> <span class="toc-text">On-disk indexing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#current-status"><span class="toc-number">3.</span> <span class="toc-text">Current status</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#supported-field-types"><span class="toc-number">3.1.</span> <span class="toc-text">Supported field types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transaction-guarantees"><span class="toc-number">3.2.</span> <span class="toc-text">Transaction guarantees</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limitation-on-ir-optimizer"><span class="toc-number">3.3.</span> <span class="toc-text">Limitation on IR optimizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#relationship-with-other-features"><span class="toc-number">3.4.</span> <span class="toc-text">Relationship with other
features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compliance"><span class="toc-number">3.5.</span> <span class="toc-text">Compliance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#high-experimental"><span class="toc-number">3.6.</span> <span class="toc-text">High experimental!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#future-outlook"><span class="toc-number">4.</span> <span class="toc-text">Future outlook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vector-search"><span class="toc-number">4.1.</span> <span class="toc-text">Vector search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#full-text-search"><span class="toc-number">4.2.</span> <span class="toc-text">Full-text search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#more-sql-features"><span class="toc-number">4.3.</span> <span class="toc-text">More SQL features</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#try-it"><span class="toc-number">5.</span> <span class="toc-text">Try it!</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://imtwice.com/kqir-query-engine/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://imtwice.com/kqir-query-engine/&text=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://imtwice.com/kqir-query-engine/&is_video=false&description=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries&body=Check out this article: https://imtwice.com/kqir-query-engine/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://imtwice.com/kqir-query-engine/&title=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://imtwice.com/kqir-query-engine/&name=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://imtwice.com/kqir-query-engine/&t=KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2025
    Pragma Twice
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'imtwice';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>
